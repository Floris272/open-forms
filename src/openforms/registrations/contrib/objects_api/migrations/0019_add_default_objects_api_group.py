# Generated by Django 4.2.11 on 2024-07-02 15:18

from django.db import migrations

from django.db.migrations.state import StateApps
from django.db.backends.base.schema import BaseDatabaseSchemaEditor


def add_default_objects_api_group(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    FormRegistrationBackend = apps.get_model("forms", "FormRegistrationBackend")
    ObjectsAPIGroupConfig = apps.get_model(
        "registrations_objects_api", "ObjectsAPIGroupConfig"
    )

    objects_api_group_config = ObjectsAPIGroupConfig.objects.order_by("pk").first()
    if objects_api_group_config is None:
        # Because this migration runs after registrations_objects_api/0017_move_singleton_data,
        # Having no Objects API Group means we had no solo config in the first place, thus
        # it is safe to assume no Objects API registration backend was set up.
        return

    for registration_backend in FormRegistrationBackend.objects.filter(
        backend="objects_api"
    ):
        registration_backend.options.setdefault(
            "objects_api_group", objects_api_group_config.pk
        )
        registration_backend.save()


class Migration(migrations.Migration):

    dependencies = [
        (
            "registrations_objects_api",
            "0018_remove_objectsapiconfig_catalogi_service_and_more",
        ),
        (
            "forms",
            "0100_add_default_objects_api_group",
        ),
    ]

    operations = [
        migrations.RunPython(
            add_default_objects_api_group,
            migrations.RunPython.noop,
        ),
    ]
