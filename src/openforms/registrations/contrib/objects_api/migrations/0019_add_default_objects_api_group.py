# Generated by Django 4.2.11 on 2024-07-02 15:18

from django.db import migrations
from django.db.backends.base.schema import BaseDatabaseSchemaEditor
from django.db.migrations.state import StateApps


def add_default_objects_api_group(
    apps: StateApps, schema_editor: BaseDatabaseSchemaEditor
) -> None:
    FormRegistrationBackend = apps.get_model("forms", "FormRegistrationBackend")
    ObjectsAPIGroupConfig = apps.get_model(
        "registrations_objects_api", "ObjectsAPIGroupConfig"
    )
    backends_qs = FormRegistrationBackend.objects.filter(backend="objects_api")
    # nothing to do if there are no relevant backends
    if not backends_qs.exists():
        return

    objects_api_group_config = ObjectsAPIGroupConfig.objects.order_by("pk").first()
    if objects_api_group_config is None:
        # This shouldn't happen because of:
        # * upgrade checks
        # * operations in registrations_objects_api/0017_move_singleton_data
        #
        # BUT that doesn't mean it's impossible, like on continuously deployed
        # environments... For those cases, we generate a (knowingly broken)
        # configuration so that migrations don't crash and options have at least the
        # right shape so that we can trust the type annotations.
        objects_api_group_config = ObjectsAPIGroupConfig.objects.create(
            name="AUTO_GENERATED - FIXME",
            # DeprecationWarning
            # Open Forms 3.0 will drop the nullable fields, so this data migration needs
            # to be gone by then.
            objects_service=None,
            objecttypes_service=None,
            drc_service=None,
            catalogi_service=None,
        )

    for registration_backend in backends_qs:
        registration_backend.options.setdefault(
            "objects_api_group", objects_api_group_config.pk
        )
        registration_backend.save()


class Migration(migrations.Migration):

    dependencies = [
        (
            "registrations_objects_api",
            "0018_remove_objectsapiconfig_catalogi_service_and_more",
        ),
        (
            "forms",
            "0100_add_default_objects_api_group",
        ),
    ]

    operations = [
        migrations.RunPython(
            add_default_objects_api_group,
            migrations.RunPython.noop,
        ),
    ]
