# Generated by Django 4.2.11 on 2024-06-03 14:21

from django.db import migrations

from flags.conditions import boolean_condition

FIELDS = (
    "enable_demo_plugins",
    "display_sdk_information",
)


def move_from_config_to_flagstate(apps, _):
    GlobalConfiguration = apps.get_model("config", "GlobalConfiguration")
    FlagState = apps.get_model("flags", "FlagState")

    # ensure we have an instance, for a fresh install, this will set up the
    # defaults explicitly.
    config = GlobalConfiguration.objects.first() or GlobalConfiguration()
    for field in FIELDS:
        current_value = getattr(config, field)
        FlagState.objects.get_or_create(
            name=field.upper(),
            defaults={
                "condition": "boolean",
                "value": str(current_value),
                "required": False,
            },
        )


def move_from_flagstate_to_config(apps, _):
    GlobalConfiguration = apps.get_model("config", "GlobalConfiguration")
    FlagState = apps.get_model("flags", "FlagState")

    # if there's no config, there's nothing to do
    config = GlobalConfiguration.objects.first()
    if config is None:
        return

    for field in FIELDS:
        flag_state = FlagState.objects.filter(
            name=field.upper(), condition="boolean"
        ).first()
        if flag_state is None:
            continue

        value = boolean_condition(flag_state.value)
        setattr(config, field, value)

    config.save()


class Migration(migrations.Migration):

    dependencies = [
        ("config", "0060_merge_20240517_1517"),
        ("flags", "0013_add_required_field"),
    ]

    operations = [
        migrations.RunPython(
            move_from_config_to_flagstate,
            move_from_flagstate_to_config,
        ),
        migrations.RemoveField(
            model_name="globalconfiguration",
            name="display_sdk_information",
        ),
        migrations.RemoveField(
            model_name="globalconfiguration",
            name="enable_demo_plugins",
        ),
    ]
